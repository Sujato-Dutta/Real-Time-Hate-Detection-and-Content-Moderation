name: ETL → Ingestion → DVC → Build Docker → Deploy to Hugging Face Spaces

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: hf-spaces-deploy
  cancel-in-progress: true

jobs:
  etl-ingest-dvc:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      # Use DagsHub token as S3-compatible creds for DVC remote defined in .dvc/config
      AWS_ACCESS_KEY_ID: ${{ secrets.DAGSHUB_TOKEN }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.DAGSHUB_TOKEN }}
      # MLflow (DagsHub) from Secrets
      MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
      MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
      # Kaggle API (if dataset requires auth)
      KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
      KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
      # Supabase connection used by ETL/ingestion
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies (incl. DVC, Streamlit, KaggleHub)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "dvc[s3]" streamlit kagglehub
          # optional: install your package if setup.py present
          pip install -e .

      - name: Show tool versions
        run: |
          python --version
          dvc --version
          streamlit --version

      - name: Show DVC remotes
        run: |
          dvc remote list -v || true
          cat .dvc/config || true

      - name: Remove DVC tracking and use Git for artifacts
        run: |
          # Remove DVC tracking of artifacts since we're using Git now
          git rm --cached artifacts/*.joblib || true
          git add .
          git commit -m "Remove DVC tracking of artifacts" || true
          
      - name: Run ETL pipeline (Kaggle → transform → Supabase)
        run: |
          python run_etl_pipeline.py

      - name: Run data ingestion check (Supabase → DataFrame)
        run: |
          python run_data_ingestion

      - name: Generate artifacts (preprocess → train)
        run: |
          python -c "import subprocess; subprocess.run(['dvc', 'repro'], check=False)"
          
      - name: Commit artifacts to Git
        run: |
          git add artifacts/
          git commit -m "Update model artifacts" || echo "No changes to commit"

      - name: Verify artifacts exist locally
        run: |
          ls -la artifacts/
          echo "Artifacts generated:"
          find artifacts/ -name "*.joblib" -type f

      - name: Commit updated dvc.lock (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dvc.lock
          git diff --staged --quiet || git commit -m "CI: update dvc.lock [skip ci]"
          git push

  docker-build:
    needs: etl-ingest-dvc
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout with artifacts
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
          
      - name: Pull latest changes with artifacts
        run: |
          git pull origin ${{ github.ref_name }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image name
        id: meta
        shell: bash
        run: |
          NAME="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"
          # Lowercase & sanitize: replace non-alnum with '-', trim leading/trailing '-'
          SANITIZED_NAME=$(echo "$NAME"  | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g;s/^-+//;s/-+$//')
          SANITIZED_OWNER=$(echo "$OWNER" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9-]+/-/g;s/^-+//;s/-+$//')
          echo "image=ghcr.io/${SANITIZED_OWNER}/${SANITIZED_NAME}" >> "$GITHUB_OUTPUT"

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.meta.outputs.image }}:latest
            ${{ steps.meta.outputs.image }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-to-space:
    needs: docker-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure full history (unshallow if needed)
        shell: bash
        run: |
          if git rev-parse --is-shallow-repository | grep -q true; then
            git fetch --unshallow --tags
          fi

      - name: Ensure empty artifacts dir exists for Space build
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          mkdir -p artifacts
          touch artifacts/.gitkeep
          git add artifacts/.gitkeep
          git commit -m "CI: add empty artifacts dir for Space build" || true

      - name: Prepare Space repo (filtered, no binaries)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf space_repo
          mkdir -p space_repo

          # Copy only what the Space needs (no large binaries)
          [ -d app ] && cp -r app space_repo/ || true
          [ -d src ] && cp -r src space_repo/ || true
          [ -d .dvc ] && cp -r .dvc space_repo/ || true
          for f in dvc.yaml dvc.lock requirements.txt Dockerfile README.md setup.py; do
            [ -f "$f" ] && cp "$f" space_repo/ || true
          done

          # Ensure Dockerfile's COPY artifacts step has a source; commit a marker so Git tracks the dir
          mkdir -p space_repo/artifacts
          touch space_repo/artifacts/.gitkeep

          # Add .gitignore to keep Space repo clean, but allow the .gitkeep to be tracked
          cat > space_repo/.gitignore << 'EOF'
          artifacts/*
          !artifacts/.gitkeep
          data/
          mlruns/
          *.log
          __pycache__/
          .DS_Store
          EOF

      - name: Push to Hugging Face Space (filtered)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USER: ${{ secrets.HF_USER }}
          HF_SPACE: ${{ secrets.HF_SPACE }}
        run: |
          set -euo pipefail
          cd space_repo
          git init -b main
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "CI: deploy to Space (filtered, no binary artifacts)"
          git remote add space "https://${HF_USER}:${HF_TOKEN}@huggingface.co/spaces/${HF_USER}/${HF_SPACE}"
          # Force-push a minimal tree without binary artifacts
          git push --force space main